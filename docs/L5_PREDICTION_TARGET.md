# L5 ëª¨ë¸ ì˜ˆì¸¡ ëŒ€ìƒ ê°€ì´ë“œ

## ğŸ“ L5ê°€ ì •í™•íˆ ì˜ˆì¸¡í•˜ëŠ” ê²ƒ

### í•µì‹¬ ë‹µë³€

**L5ëŠ” ë¯¸ë˜ ìˆ˜ìµë¥ (Forward Return)ì„ ì˜ˆì¸¡í•©ë‹ˆë‹¤.**

- **ë‹¨ê¸° ëª¨ë¸**: 20ì¼ í›„ ìˆ˜ìµë¥  (`ret_fwd_20d`) ì˜ˆì¸¡
- **ì¥ê¸° ëª¨ë¸**: 120ì¼ í›„ ìˆ˜ìµë¥  (`ret_fwd_120d`) ì˜ˆì¸¡

---

## 1. L5 ì˜ˆì¸¡ ëŒ€ìƒ ìƒì„¸

### ğŸ“Š ì˜ˆì¸¡ íƒ€ê²Ÿ ë³€ìˆ˜

#### ë‹¨ê¸° ëª¨ë¸ (20ì¼)
```
íƒ€ê²Ÿ ë³€ìˆ˜: ret_fwd_20d
ì˜ë¯¸: í˜„ì¬ ì‹œì ì—ì„œ 20ì¼ í›„ì˜ ìˆ˜ìµë¥ 
ê³„ì‚°: (20ì¼ í›„ ê°€ê²© - í˜„ì¬ ê°€ê²©) / í˜„ì¬ ê°€ê²©
```

#### ì¥ê¸° ëª¨ë¸ (120ì¼)
```
íƒ€ê²Ÿ ë³€ìˆ˜: ret_fwd_120d
ì˜ë¯¸: í˜„ì¬ ì‹œì ì—ì„œ 120ì¼ í›„ì˜ ìˆ˜ìµë¥ 
ê³„ì‚°: (120ì¼ í›„ ê°€ê²© - í˜„ì¬ ê°€ê²©) / í˜„ì¬ ê°€ê²©
```

### ğŸ”§ ì½”ë“œì—ì„œ í™•ì¸

```603:611:src/stages/modeling/l5_train_models.py
        y_train_raw = dtrain[target_col].to_numpy(dtype=np.float32, copy=False)
        y_test_raw = dtest[target_col].to_numpy(dtype=np.float32, copy=False)

        if target_transform == "cs_rank":
            y_train = _cs_rank_by_date(dtrain, target_col, center=cs_rank_center)
            y_test_metric = _cs_rank_by_date(dtest, target_col, center=cs_rank_center)
        else:
            y_train = y_train_raw
            y_test_metric = y_test_raw
```

**target_col ê°’:**
- ë‹¨ê¸°: `"ret_fwd_20d"`
- ì¥ê¸°: `"ret_fwd_120d"`

### ğŸ“ˆ ì˜ˆì¸¡ ê³¼ì •

```
ì…ë ¥ (X):
  - í”¼ì²˜ë“¤ (ê¸°ìˆ ì  ì§€í‘œ, ì¬ë¬´ ì§€í‘œ, ë‰´ìŠ¤ ê°ì„±, ESG ë“±)
  - ì˜ˆ: rsi_14, pe_ratio, news_sentiment, esg_score, ...

íƒ€ê²Ÿ (y):
  - ret_fwd_20d (ë‹¨ê¸° ëª¨ë¸)
  - ret_fwd_120d (ì¥ê¸° ëª¨ë¸)

ëª¨ë¸ í•™ìŠµ:
  Ridge ëª¨ë¸ì´ í”¼ì²˜(X)ì™€ ìˆ˜ìµë¥ (y)ì˜ ê´€ê³„ í•™ìŠµ

ì¶œë ¥ (y_pred):
  - ì˜ˆì¸¡ëœ ìˆ˜ìµë¥  ê°’
  - ì˜ˆ: 0.05 (5% ìˆ˜ìµë¥  ì˜ˆì¸¡), -0.02 (-2% ì†ì‹¤ ì˜ˆì¸¡)
```

---

## 2. íˆ¬íŠ¸ë™ ì „ëµê³¼ ë¹„êµ

### ğŸ“Š ì „ì²´ êµ¬ì¡° ë¹„êµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ê³µí†µ ë°ì´í„° ì¤€ë¹„ (L0~L4)                   â”‚
â”‚  - Universe, OHLCV, ì¬ë¬´ ë°ì´í„°, CV ë¶„í•                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Track A (ë­í‚¹ ì—”ì§„)     â”‚                   â”‚ Track B (íˆ¬ì ëª¨ë¸)        â”‚
â”‚                        â”‚                   â”‚                            â”‚
â”‚ L8: ë­í‚¹ ìƒì„±          â”‚                   â”‚ L5: ìˆ˜ìµë¥  ì˜ˆì¸¡ â­          â”‚
â”‚  - í”¼ì²˜ ê°€ì¤‘ì¹˜ í•©ì‚°    â”‚                   â”‚  - Ridge ëª¨ë¸ í•™ìŠµ          â”‚
â”‚  - ë­í‚¹ ì ìˆ˜ ê³„ì‚°      â”‚                   â”‚  - ret_fwd_20d ì˜ˆì¸¡         â”‚
â”‚  - ranking_daily ìƒì„±  â”‚                   â”‚  - ret_fwd_120d ì˜ˆì¸¡        â”‚
â”‚                        â”‚                   â”‚                            â”‚
â”‚ âŒ ì˜ˆì¸¡ ì—†ìŒ           â”‚                   â”‚ âœ… ìˆ˜ìµë¥  ì˜ˆì¸¡              â”‚
â”‚ âœ… ë­í‚¹ë§Œ ìƒì„±         â”‚                   â”‚ âœ… ëª¨ë¸ í•™ìŠµ í•„ìš”           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                             â”‚
        â”‚                                             â†“
        â”‚                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                   â”‚ L6: ìŠ¤ì½”ì–´ ê²°í•©              â”‚
        â”‚                                   â”‚  - ëª¨ë¸ ì˜ˆì¸¡ê°’ ê²°í•©          â”‚
        â”‚                                   â”‚  - score_ens ìƒì„±            â”‚
        â”‚                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                             â”‚
        â”‚                                             â†“
        â”‚                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                   â”‚ L7: ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰            â”‚
        â”‚                                   â”‚  - score_ensë¡œ í¬íŠ¸í´ë¦¬ì˜¤ êµ¬ì„±â”‚
        â”‚                                   â”‚  - ì„±ê³¼ í‰ê°€                 â”‚
        â”‚                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                            â†“
                                    [ìµœì¢… ê²°ê³¼]
```

---

## 3. Track A vs Track B ìƒì„¸ ë¹„êµ

### ğŸ¯ Track A: ë­í‚¹ ì—”ì§„ (L8)

**ëª©ì **: í”¼ì²˜ ê¸°ë°˜ ì¢…ëª© ë­í‚¹ ìƒì„±

**ì²˜ë¦¬ ë°©ì‹:**
```
ì…ë ¥:
  - í”¼ì²˜ë“¤ (ê¸°ìˆ ì  ì§€í‘œ, ì¬ë¬´ ì§€í‘œ, ë‰´ìŠ¤ ê°ì„±, ESG ë“±)
  - í”¼ì²˜ ê°€ì¤‘ì¹˜ (config íŒŒì¼ì—ì„œ ì„¤ì •)

ì²˜ë¦¬:
  - í”¼ì²˜ ê°’ì— ê°€ì¤‘ì¹˜ ê³±í•˜ê¸°
  - ê°€ì¤‘ì¹˜ í•©ì‚°ìœ¼ë¡œ ì ìˆ˜ ê³„ì‚°
  - ì ìˆ˜ ìˆœìœ¼ë¡œ ë­í‚¹ ìƒì„±

ì¶œë ¥:
  - ranking_short_daily (ë‹¨ê¸° ë­í‚¹)
  - ranking_long_daily (ì¥ê¸° ë­í‚¹)
  - ì»¬ëŸ¼: score_total, rank_total
```

**íŠ¹ì§•:**
- âŒ **ì˜ˆì¸¡ ì—†ìŒ**: ëª¨ë¸ í•™ìŠµ ì—†ì´ ê°€ì¤‘ì¹˜ í•©ì‚°ë§Œ ìˆ˜í–‰
- âœ… **ë¹ ë¦„**: ìˆ˜ ì´ˆ ~ ìˆ˜ ë¶„ (ëª¨ë¸ í•™ìŠµ ë¶ˆí•„ìš”)
- âœ… **í•´ì„ ê°€ëŠ¥**: í”¼ì²˜ ê°€ì¤‘ì¹˜ê°€ ëª…í™•í•¨
- âœ… **ë‹¨ìˆœí•¨**: ë³µì¡í•œ ê³„ì‚° ì—†ìŒ

**ì˜ˆì‹œ:**
```python
# L8 ë­í‚¹ ìƒì„±
score_total = (
    0.1 * rsi_14 +
    0.2 * pe_ratio +
    0.15 * news_sentiment +
    0.1 * esg_score +
    ...
)

# ë­í‚¹ ìƒì„±
rank_total = score_total.rank(ascending=False)
```

---

### ğŸ’¼ Track B: íˆ¬ì ëª¨ë¸ (L5)

**ëª©ì **: ë¯¸ë˜ ìˆ˜ìµë¥  ì˜ˆì¸¡

**ì²˜ë¦¬ ë°©ì‹:**
```
ì…ë ¥:
  - í”¼ì²˜ë“¤ (ê¸°ìˆ ì  ì§€í‘œ, ì¬ë¬´ ì§€í‘œ, ë‰´ìŠ¤ ê°ì„±, ESG ë“±)
  - íƒ€ê²Ÿ: ret_fwd_20d (ë‹¨ê¸°) ë˜ëŠ” ret_fwd_120d (ì¥ê¸°)

ì²˜ë¦¬:
  - Ridge ëª¨ë¸ í•™ìŠµ (í”¼ì²˜ì™€ ìˆ˜ìµë¥ ì˜ ê´€ê³„ í•™ìŠµ)
  - ëª¨ë¸ì´ í”¼ì²˜ë¥¼ ë³´ê³  ìˆ˜ìµë¥  ì˜ˆì¸¡

ì¶œë ¥:
  - pred_short_oos (ë‹¨ê¸° ì˜ˆì¸¡)
  - pred_long_oos (ì¥ê¸° ì˜ˆì¸¡)
  - ì»¬ëŸ¼: y_pred (ì˜ˆì¸¡ ìˆ˜ìµë¥ ), y_true (ì‹¤ì œ ìˆ˜ìµë¥ )
```

**íŠ¹ì§•:**
- âœ… **ì˜ˆì¸¡ ìˆ˜í–‰**: ëª¨ë¸ì´ ë¯¸ë˜ ìˆ˜ìµë¥ ì„ ì˜ˆì¸¡
- â±ï¸ **ëŠë¦¼**: ìˆ˜ ë¶„ ~ ìˆ˜ì‹­ ë¶„ (ëª¨ë¸ í•™ìŠµ í•„ìš”)
- âš ï¸ **í•´ì„ ì–´ë ¤ì›€**: ëª¨ë¸ì´ í•™ìŠµí•œ ê´€ê³„ëŠ” ë³µì¡í•  ìˆ˜ ìˆìŒ
- âœ… **ì •í™•ë„**: ëª¨ë¸ì´ ë°ì´í„°ë¡œë¶€í„° íŒ¨í„´ í•™ìŠµ

**ì˜ˆì‹œ:**
```python
# L5 ëª¨ë¸ í•™ìŠµ
model = Ridge(alpha=8.0)
model.fit(X_train, y_train)  # X: í”¼ì²˜ë“¤, y: ret_fwd_20d

# ì˜ˆì¸¡
y_pred = model.predict(X_test)
# ì˜ˆ: y_pred = 0.05 (5% ìˆ˜ìµë¥  ì˜ˆì¸¡)
```

---

## 4. L5 ì˜ˆì¸¡ ê³¼ì • ìƒì„¸

### ğŸ“Š ë‹¨ê³„ë³„ ì„¤ëª…

#### Step 1: ë°ì´í„° ì¤€ë¹„
```
dataset_daily.parquet
  â”œâ”€ date: ë‚ ì§œ
  â”œâ”€ ticker: ì¢…ëª© ì½”ë“œ
  â”œâ”€ í”¼ì²˜ë“¤: rsi_14, pe_ratio, news_sentiment, ...
  â””â”€ íƒ€ê²Ÿ: ret_fwd_20d (ë‹¨ê¸°) ë˜ëŠ” ret_fwd_120d (ì¥ê¸°)
```

#### Step 2: CV ë¶„í• 
```
cv_folds_short.parquet ë˜ëŠ” cv_folds_long.parquet
  â”œâ”€ fold_id: í´ë“œ ID
  â”œâ”€ train_start, train_end: í•™ìŠµ ê¸°ê°„
  â””â”€ test_start, test_end: í…ŒìŠ¤íŠ¸ ê¸°ê°„
```

#### Step 3: ëª¨ë¸ í•™ìŠµ
```python
# ê° foldë³„ë¡œ í•™ìŠµ
for fold in cv_folds:
    # í•™ìŠµ ë°ì´í„°
    X_train = dataset[train_start:train_end][í”¼ì²˜ë“¤]
    y_train = dataset[train_start:train_end]["ret_fwd_20d"]

    # ëª¨ë¸ í•™ìŠµ
    model = Ridge(alpha=8.0)
    model.fit(X_train, y_train)

    # í…ŒìŠ¤íŠ¸ ë°ì´í„° ì˜ˆì¸¡
    X_test = dataset[test_start:test_end][í”¼ì²˜ë“¤]
    y_pred = model.predict(X_test)
```

#### Step 4: ì˜ˆì¸¡ ê²°ê³¼ ì €ì¥
```
pred_short_oos.parquet ë˜ëŠ” pred_long_oos.parquet
  â”œâ”€ date: ë‚ ì§œ
  â”œâ”€ ticker: ì¢…ëª© ì½”ë“œ
  â”œâ”€ y_pred: ì˜ˆì¸¡ ìˆ˜ìµë¥  (ëª¨ë¸ ì¶œë ¥)
  â”œâ”€ y_true: ì‹¤ì œ ìˆ˜ìµë¥  (ê²€ì¦ìš©)
  â”œâ”€ fold_id: í´ë“œ ID
  â””â”€ phase: dev ë˜ëŠ” holdout
```

---

## 5. L5 vs L8 ë¹„êµí‘œ

| êµ¬ë¶„ | Track A (L8) | Track B (L5) |
|------|-------------|--------------|
| **ëª©ì ** | ë­í‚¹ ìƒì„± | ìˆ˜ìµë¥  ì˜ˆì¸¡ |
| **ë°©ì‹** | í”¼ì²˜ ê°€ì¤‘ì¹˜ í•©ì‚° | ëª¨ë¸ í•™ìŠµ |
| **ì…ë ¥** | í”¼ì²˜ë“¤ + ê°€ì¤‘ì¹˜ | í”¼ì²˜ë“¤ + íƒ€ê²Ÿ(ìˆ˜ìµë¥ ) |
| **ì²˜ë¦¬** | ê°€ì¤‘ì¹˜ í•©ì‚° | Ridge íšŒê·€ í•™ìŠµ |
| **ì¶œë ¥** | ë­í‚¹ ì ìˆ˜ (score_total) | ì˜ˆì¸¡ ìˆ˜ìµë¥  (y_pred) |
| **ëª¨ë¸ í•™ìŠµ** | âŒ ì—†ìŒ | âœ… í•„ìš” |
| **ì‹¤í–‰ ì‹œê°„** | ë¹ ë¦„ (ìˆ˜ ì´ˆ) | ëŠë¦¼ (ìˆ˜ ë¶„) |
| **í•´ì„ ê°€ëŠ¥ì„±** | ë†’ìŒ | ì¤‘ê°„ |
| **ì •í™•ë„** | ê°€ì¤‘ì¹˜ì— ì˜ì¡´ | ëª¨ë¸ì´ í•™ìŠµ |
| **ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤** | ë­í‚¹ë§Œ í•„ìš”í•  ë•Œ | ì˜ˆì¸¡ ì„±ëŠ¥ í™•ì¸ í•„ìš”í•  ë•Œ |

---

## 6. ì‹¤ì œ ì‚¬ìš© ì˜ˆì‹œ

### ğŸ“Š Track A ì‚¬ìš© ì‹œ

```python
# L8 ì‹¤í–‰: ë­í‚¹ë§Œ ìƒì„±
python -m src.pipeline.track_a_pipeline

# ê²°ê³¼: ranking_short_daily.parquet
# ì»¬ëŸ¼: score_total, rank_total
# ì˜ˆ: ì‚¼ì„±ì „ì score_total = 0.85, rank_total = 1ìœ„
```

**íŠ¹ì§•:**
- ë¹ ë¥´ê²Œ ë­í‚¹ë§Œ í™•ì¸ ê°€ëŠ¥
- ëª¨ë¸ í•™ìŠµ ë¶ˆí•„ìš”
- í”¼ì²˜ ê°€ì¤‘ì¹˜ë§Œ ì¡°ì •í•˜ë©´ ë­í‚¹ ë³€ê²½

---

### ğŸ“Š Track B ì‚¬ìš© ì‹œ

```python
# L5 ì‹¤í–‰: ëª¨ë¸ í•™ìŠµ ë° ì˜ˆì¸¡
python scripts/run_pipeline_l0_l7.py

# ê²°ê³¼: pred_short_oos.parquet
# ì»¬ëŸ¼: y_pred, y_true
# ì˜ˆ: ì‚¼ì„±ì „ì y_pred = 0.05 (5% ìˆ˜ìµë¥  ì˜ˆì¸¡)
```

**íŠ¹ì§•:**
- ëª¨ë¸ì´ ìˆ˜ìµë¥ ì„ ì§ì ‘ ì˜ˆì¸¡
- ì˜ˆì¸¡ ì •í™•ë„ í™•ì¸ ê°€ëŠ¥ (IC, Hit Ratio ë“±)
- ëª¨ë¸ í•™ìŠµ ì‹œê°„ í•„ìš”

---

## 7. L5 ì˜ˆì¸¡ê°’ì˜ í™œìš©

### ğŸ“ˆ L6ì—ì„œ ìŠ¤ì½”ì–´ ê²°í•©

```python
# L6: L5 ì˜ˆì¸¡ê°’ì„ ìŠ¤ì½”ì–´ë¡œ ë³€í™˜
score_short = pred_short_oos["y_pred"]  # ë‹¨ê¸° ì˜ˆì¸¡ê°’
score_long = pred_long_oos["y_pred"]     # ì¥ê¸° ì˜ˆì¸¡ê°’

# ê°€ì¤‘ì¹˜ ê²°í•©
score_ens = 0.5 * score_short + 0.5 * score_long
```

### ğŸ“Š L7ì—ì„œ ë°±í…ŒìŠ¤íŠ¸

```python
# L7: score_ensë¡œ í¬íŠ¸í´ë¦¬ì˜¤ êµ¬ì„±
# score_ensê°€ ë†’ì€ ì¢…ëª©ì„ ë§¤ìˆ˜
top_k = 12  # ìƒìœ„ 12ê°œ ì¢…ëª© ì„ íƒ
positions = score_ens.nlargest(top_k)

# ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰
returns = calculate_portfolio_returns(positions)
```

---

## 8. ìš”ì•½

### âœ… L5ê°€ ì˜ˆì¸¡í•˜ëŠ” ê²ƒ

1. **ë‹¨ê¸° ëª¨ë¸**: `ret_fwd_20d` (20ì¼ í›„ ìˆ˜ìµë¥ )
2. **ì¥ê¸° ëª¨ë¸**: `ret_fwd_120d` (120ì¼ í›„ ìˆ˜ìµë¥ )

### ğŸ¯ Track A vs Track B

| | Track A (L8) | Track B (L5) |
|--|-------------|--------------|
| **ì˜ˆì¸¡ ì—¬ë¶€** | âŒ ì˜ˆì¸¡ ì—†ìŒ | âœ… ìˆ˜ìµë¥  ì˜ˆì¸¡ |
| **ë°©ì‹** | ê°€ì¤‘ì¹˜ í•©ì‚° | ëª¨ë¸ í•™ìŠµ |
| **ì†ë„** | ë¹ ë¦„ | ëŠë¦¼ |
| **ì •í™•ë„** | ê°€ì¤‘ì¹˜ ì˜ì¡´ | ëª¨ë¸ í•™ìŠµ |

### ğŸ“Š í•µì‹¬ ì°¨ì´

- **Track A**: ë­í‚¹ë§Œ ìƒì„± (ì˜ˆì¸¡ ì—†ìŒ)
- **Track B**: ìˆ˜ìµë¥  ì˜ˆì¸¡ (ëª¨ë¸ í•™ìŠµ í•„ìš”)

---

**ì‘ì„±ì¼**: 2025-01-XX
**ì‘ì„±ì**: Cursor AI
**ë²„ì „**: 1.0
